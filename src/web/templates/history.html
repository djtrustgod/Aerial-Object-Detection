{% extends "base.html" %}

{% block title %}History - Aerial Detection{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>Detection History</h2>
        <div class="filter-controls">
            <button class="btn" onclick="refreshHistory()">Refresh</button>
            <button class="btn btn-danger" id="delete-btn" onclick="deleteSelected()" disabled>Delete Selected</button>
        </div>
    </div>
    <div class="card-body">
        <table class="event-table" id="history-table">
            <thead>
                <tr>
                    <th><input type="checkbox" id="select-all" title="Select all"></th>
                    <th>ID</th>
                    <th>Time</th>
                    <th>Position</th>
                    <th>Speed</th>
                    <th>Track Length</th>
                    <th>Clip</th>
                </tr>
            </thead>
            <tbody>
                {% for event in events %}
                <tr class="event-row">
                    <td><input type="checkbox" class="row-check" value="{{ event.event_id }}"></td>
                    <td>{{ event.event_id }}</td>
                    <td>{{ event.start_time | format_ts }}</td>
                    <td>({{ "%.0f"|format(event.avg_x) }}, {{ "%.0f"|format(event.avg_y) }})</td>
                    <td>{{ "%.1f"|format(event.avg_speed) }} px/f</td>
                    <td>{{ event.trajectory_length }}</td>
                    <td>
                        {% if event.clip_path %}
                        <a href="/clips/{{ event.clip_path | basename }}" target="_blank" class="btn btn-small">Play</a>
                        {% else %}
                        --
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
                {% if not events %}
                <tr><td colspan="7" class="empty-state">No events recorded yet</td></tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- Clip playback modal -->
<div id="clip-modal" class="modal" style="display:none;">
    <div class="modal-content">
        <span class="modal-close" onclick="closeModal()">&times;</span>
        <video id="clip-player" controls autoplay></video>
    </div>
</div>
{% endblock %}

{% block head %}
<style>
.btn-danger {
    background: #8b1a1a;
    color: #fff;
    border-color: #8b1a1a;
}
.btn-danger:hover {
    background: #b22222;
    border-color: #b22222;
}
</style>
{% endblock %}

{% block scripts %}
<script>
function updateDeleteButton() {
    const count = document.querySelectorAll('.row-check:checked').length;
    const all = document.querySelectorAll('.row-check');
    const selAll = document.getElementById('select-all');
    const allChecked = all.length > 0 && count === all.length;
    const btn = document.getElementById('delete-btn');
    if (btn) {
        btn.disabled = count === 0;
        btn.textContent = allChecked ? 'Delete All' : count > 0 ? `Delete Selected (${count})` : 'Delete Selected';
    }
    if (selAll && all.length > 0) {
        selAll.checked = allChecked;
        selAll.indeterminate = count > 0 && count < all.length;
    }
}

function bindCheckboxes() {
    document.querySelectorAll('.row-check').forEach(cb =>
        cb.addEventListener('change', updateDeleteButton)
    );
    const selAll = document.getElementById('select-all');
    if (selAll) {
        selAll.addEventListener('change', function () {
            document.querySelectorAll('.row-check')
                .forEach(cb => { cb.checked = this.checked; });
            updateDeleteButton();
        });
    }
}

async function deleteSelected() {
    const checked = [...document.querySelectorAll('.row-check:checked')];
    if (checked.length === 0) return;
    const selAll = document.getElementById('select-all');
    const deleteAll = selAll && selAll.checked && !selAll.indeterminate;
    const fetchOpts = deleteAll
        ? { method: 'DELETE' }
        : { method: 'DELETE', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ event_ids: checked.map(cb => parseInt(cb.value)) }) };
    const resp = await fetch('/api/events', fetchOpts);
    const result = await resp.json();
    if (result.status === 'ok') await refreshHistory();
}

async function refreshHistory() {
    const resp = await fetch('/api/events?limit=100');
    const events = await resp.json();
    renderTable(events);
}

function renderTable(events) {
    const tbody = document.querySelector('#history-table tbody');
    if (events.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No events found</td></tr>';
        updateDeleteButton();
        return;
    }
    tbody.innerHTML = events.map(e => `
        <tr class="event-row">
            <td><input type="checkbox" class="row-check" value="${e.event_id}"></td>
            <td>${e.event_id || '--'}</td>
            <td>${new Date(e.start_time * 1000).toLocaleString('en-US', {month:'short', day:'numeric', year:'numeric', hour:'numeric', minute:'2-digit', hour12:true})}</td>
            <td>(${e.avg_x.toFixed(0)}, ${e.avg_y.toFixed(0)})</td>
            <td>${e.avg_speed.toFixed(1)} px/f</td>
            <td>${e.trajectory_length}</td>
            <td>${e.clip_path ? `<a href="/clips/${e.clip_path.replace(/\\/g, '/').split('/').pop()}" target="_blank" class="btn btn-small">Play</a>` : '--'}</td>
        </tr>
    `).join('');
    bindCheckboxes();
    updateDeleteButton();
}

function closeModal() {
    document.getElementById('clip-modal').style.display = 'none';
    document.getElementById('clip-player').pause();
}

// Initial bind for server-rendered rows
bindCheckboxes();
</script>
{% endblock %}
