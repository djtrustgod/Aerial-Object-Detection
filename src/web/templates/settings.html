{% extends "base.html" %}

{% block title %}Settings - Aerial Detection{% endblock %}

{% block content %}
<div class="settings-grid">
    <!-- Detection Settings -->
    <div class="card">
        <div class="card-header">
            <h2>Detection Parameters</h2>
        </div>
        <div class="card-body">
            <form id="detection-form" onsubmit="return saveDetection(event)">
                <div class="form-group">
                    <label>Diff Threshold</label>
                    <input type="number" name="diff_threshold" value="{{ config.detection.diff_threshold }}" min="1" max="255">
                </div>
                <div class="form-group">
                    <label>MOG2 Var Threshold</label>
                    <input type="number" name="mog2_var_threshold" value="{{ config.detection.mog2_var_threshold }}" min="1" max="200">
                </div>
                <div class="form-group">
                    <label>Min Contour Area (px²)</label>
                    <input type="number" name="min_contour_area" value="{{ config.detection.min_contour_area }}" min="1" max="1000">
                </div>
                <div class="form-group">
                    <label>Max Contour Area (px²)</label>
                    <input type="number" name="max_contour_area" value="{{ config.detection.max_contour_area }}" min="10" max="10000">
                </div>
                <div class="form-group">
                    <label>Min Circularity</label>
                    <input type="number" name="min_circularity" value="{{ config.detection.min_circularity }}" min="0" max="1" step="0.05">
                </div>
                <div class="form-group">
                    <label>Morph Erode Iterations</label>
                    <input type="number" name="morph_erode_iterations" value="{{ config.detection.morph_erode_iterations }}" min="0" max="5">
                </div>
                <div class="form-group">
                    <label>Morph Dilate Iterations</label>
                    <input type="number" name="morph_dilate_iterations" value="{{ config.detection.morph_dilate_iterations }}" min="0" max="5">
                </div>
                <button type="submit" class="btn">Apply</button>
                <span id="detection-status" class="save-status"></span>
            </form>
        </div>
    </div>

    <!-- Tracking Settings -->
    <div class="card">
        <div class="card-header">
            <h2>Tracking Parameters</h2>
        </div>
        <div class="card-body">
            <form id="tracking-form" onsubmit="return saveTracking(event)">
                <div class="form-group">
                    <label>Max Match Distance (px)</label>
                    <input type="number" name="max_distance" value="{{ config.tracking.max_distance }}" min="5" max="200">
                </div>
                <div class="form-group">
                    <label>Max Disappeared Frames</label>
                    <input type="number" name="max_disappeared" value="{{ config.tracking.max_disappeared }}" min="1" max="100">
                </div>
                <div class="form-group">
                    <label>Min Track Length</label>
                    <input type="number" name="min_track_length" value="{{ config.tracking.min_track_length }}" min="2" max="50">
                </div>
                <button type="submit" class="btn">Apply</button>
                <span id="tracking-status" class="save-status"></span>
            </form>
        </div>
    </div>

    <!-- System Info -->
    <div class="card">
        <div class="card-header">
            <h2>System Info</h2>
        </div>
        <div class="card-body">
            <div id="system-info" class="info-grid">
                <div class="info-item"><span class="info-label">Processing FPS:</span> <span id="sys-fps">--</span></div>
                <div class="info-item"><span class="info-label">Active Tracks:</span> <span id="sys-tracks">--</span></div>
                <div class="info-item"><span class="info-label">Frame Count:</span> <span id="sys-frames">--</span></div>
                <div class="info-item"><span class="info-label">Camera:</span> <span id="sys-connected">--</span></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function saveDetection(e) {
    e.preventDefault();
    const form = new FormData(e.target);
    const body = Object.fromEntries(form.entries());
    const resp = await fetch('/api/settings/detection', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(body),
    });
    const result = await resp.json();
    const status = document.getElementById('detection-status');
    status.textContent = result.status === 'ok' ? 'Saved!' : 'Error';
    setTimeout(() => status.textContent = '', 2000);
    return false;
}

async function saveTracking(e) {
    e.preventDefault();
    const form = new FormData(e.target);
    const body = Object.fromEntries(form.entries());
    const resp = await fetch('/api/settings/tracking', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(body),
    });
    const result = await resp.json();
    const status = document.getElementById('tracking-status');
    status.textContent = result.status === 'ok' ? 'Saved!' : 'Error';
    setTimeout(() => status.textContent = '', 2000);
    return false;
}

// Poll system stats
async function updateStats() {
    try {
        const resp = await fetch('/api/stats');
        const stats = await resp.json();
        document.getElementById('sys-fps').textContent = stats.fps;
        document.getElementById('sys-tracks').textContent = stats.active_tracks;
        document.getElementById('sys-frames').textContent = stats.frame_count;
        document.getElementById('sys-connected').textContent = stats.connected ? 'Connected' : 'Disconnected';
    } catch (e) {}
}
setInterval(updateStats, 2000);
updateStats();
</script>
{% endblock %}
